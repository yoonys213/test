<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>계산 결과</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #030BA6;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 80%;
      max-width: 800px;
      padding-bottom: 20px;
      text-align: center;
    }
    .result-title {
      font-size: 50px;
      font-weight: 900;
      margin-bottom: 20px;
    }
    .result {
      font-size: 30px;
      margin: 15px 0;
    }
    .back-btn {
      padding: 15px 30px;
      font-size: 25px;
      font-weight: bold;
      background-color: white;
      color: #030BA6;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 30px;
    }
    .back-btn:hover {
      background-color: #f0f0f0;
    }
    
    .submit-btn {
      padding: 15px 30px;
      font-size: 25px;
      font-weight: bold;
      background-color: white;
      color: #030BA6;
      border: 2px solid white;
      border-radius: 10px;
      cursor: pointer;
      display: block;
      margin: 30px auto 0;
    }
    .submit-btn:hover {
      background-color: #f0f0f0;
    }

    .debug-info {
      font-size: 14px;
      color: #ccc;
      margin-top: 30px;
      text-align: left;
      border-top: 1px solid #555;
      padding-top: 10px;
    }
  </style>

    </head>
<body>
  
  <div class="container">
    <div class="result-title">계산 결과</div>
    <div id="results"></div>
    <div id="debug" class="debug-info"></div>
    <button class="submit-btn" onclick="goToDilution()">바로 희석으로 가기</button>
    <button class="back-btn" onclick="window.location.href='calculsel.html'">돌아가기</button>
  </div>

  <script>
    // ————————————————
    // 1) 은행가 반올림 함수
    // ————————————————
    function roundHalfToEven(val, digits) {
      const factor = 10 ** digits;
      const x = val * factor;
      const i = Math.floor(x);
      const f = x - i;
      if (Math.abs(f - 0.5) < 1e-12) {
        return ((i % 2 === 0 ? i : i + 1) / factor);
      }
      return Math.round(x) / factor;
    }

    // ————————————————
    // 2) 불확도: 유효숫자 한 자리 + 은행가 반올림
    // ————————————————
    function roundUncertainty(u) {
      if (u === 0) return 0;
      const exponent = Math.floor(Math.log10(Math.abs(u)));
      const scale = 10 ** exponent;
      const scaled = u / scale;
      const rounded = roundHalfToEven(scaled, 1);
      return rounded * scale;
    }

    // ————————————————
    // 3) 값과 불확도의 자릿수 맞춤
    // ————————————————
    function formatValueWithUncertainty(value, uncertainty) {
      if (uncertainty === 0) return value.toFixed(2);
      const uncertExponent = Math.floor(Math.log10(Math.abs(uncertainty)));
      const digits = Math.max(0, -uncertExponent);
      const roundedValue = roundHalfToEven(value, digits);
      const roundedUncert = roundHalfToEven(uncertainty, digits);
      return {
        value: roundedValue.toFixed(digits),
        uncertainty: roundedUncert.toFixed(digits)
      };
    }

    // ————————————————
    // 4) "바로 희석으로 가기" 버튼 클릭 시 실행되는 함수
    // ————————————————
    function goToDilution() {
      const m = parseFloat(localStorage.getItem('standard_m'));
      const alpha = parseFloat(localStorage.getItem('standard_alpha'));
      const M = parseFloat(localStorage.getItem('standard_c'));
      const V = parseFloat(localStorage.getItem('standardSolutionVolume'));
      const tool = localStorage.getItem('selectedTool');
      const vol = localStorage.getItem('selectedVolume');
      const beta = parseFloat(localStorage.getItem('uncertainty_' + tool + '_' + vol));

      const VL = V / 1000;
      const dVL = beta / 1000;
      const n = m / M;
      const relUncert_m = alpha / m;
      const dn_raw = relUncert_m * n;
      const dn = roundUncertainty(dn_raw);
      const C = n / VL;
      const relUncert_C = (dn / n) + (dVL / VL);
      const dC_raw = C * relUncert_C;
      const dC = roundUncertainty(dC_raw);
      const cFormatted = formatValueWithUncertainty(C, dC);

      // 농도와 불확도를 dilution_step2.html에 전달
      localStorage.setItem('C1', parseFloat(cFormatted.value));
      localStorage.setItem('alpha', parseFloat(cFormatted.uncertainty));

      // 페이지 이동
      location.href = "dilution_step2.html";
    }

    // ————————————————
    // 5) 페이지 로딩 시 계산 결과 표시
    // ————————————————
    window.onload = function () {
      const m = parseFloat(localStorage.getItem('standard_m'));
      const alpha = parseFloat(localStorage.getItem('standard_alpha'));
      const M = parseFloat(localStorage.getItem('standard_c'));
      const V = parseFloat(localStorage.getItem('standardSolutionVolume'));
      const tool = localStorage.getItem('selectedTool');
      const vol = localStorage.getItem('selectedVolume');
      const beta = parseFloat(localStorage.getItem('uncertainty_' + tool + '_' + vol));

      if ([m, alpha, M, V, beta].some(x => isNaN(x))) {
        document.getElementById('results').innerHTML =
          "<div class='result' style='color:red;'>입력값 오류: 모든 값이 숫자여야 합니다.</div>";
        return;
      }

      const VL = V / 1000;
      const dVL = beta / 1000;
      const n = m / M;
      const relUncert_m = alpha / m;
      const dn_raw = relUncert_m * n;
      const dn = roundUncertainty(dn_raw);
      const C = n / VL;
      const relUncert_C = (dn / n) + (dVL / VL);
      const dC_raw = C * relUncert_C;
      const dC = roundUncertainty(dC_raw);

      const nFormatted = formatValueWithUncertainty(n, dn);
      const cFormatted = formatValueWithUncertainty(C, dC);

      document.getElementById('results').innerHTML = `
        <div class="result">
          <strong>용질의 양 (mol):</strong> ${nFormatted.value} ± ${nFormatted.uncertainty} mol
        </div>
        <div class="result">
          <strong>표준용액 농도 (H):</strong> ${cFormatted.value} ± ${cFormatted.uncertainty} mol/L
        </div>
      `;

      // // 디버그용
      // document.getElementById('debug').innerHTML = `
      //   <p><strong>디버그 정보</strong></p>
      //   <p>m = ${m} g, α = ${alpha} g, M = ${M} g/mol</p>
      //   <p>V = ${V} mL, β = ${beta} mL</p>
      //   <p>n (몰수) 계산: ${n} mol, dn (불확도): ${dn}</p>
      //   <p>C (농도) 계산: ${C} mol/L, dC (불확도): ${dC}</p>
      // `;
    };
  </script>
</body>

</html>
